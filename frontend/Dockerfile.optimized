# frontend/Dockerfile.optimized
# 前端应用Docker镜像构建文件（优化版 - 更好的缓存效率）
# 
# 改进说明:
# 1. 将依赖安装和源码分离，只有源码改变时才重新构建
# 2. 更细粒度的缓存控制
# 3. 首次构建略慢，但后续构建明显加快
#
# 使用方法:
# docker build -f Dockerfile.optimized -t stock_analysis_frontend:optimized .

# 阶段1: 构建阶段
FROM node:18-alpine AS builder

WORKDIR /app

# 配置 npm 使用国内镜像源
RUN npm config set registry https://registry.npmmirror.com

# ========== 层级 1: 依赖层（改变频率最低）==========
# 仅复制 package 文件，安装依赖
# 只有 package.json 或 package-lock.json 改变时才重新执行
COPY package*.json ./

# 清理缓存并安装依赖
RUN npm cache clean --force && \
    rm -rf node_modules && \
    npm install --force --legacy-peer-deps && \
    # 修复 hast-util-to-parse5 中 property-information 嵌套依赖问题
    rm -rf node_modules/hast-util-to-parse5/node_modules/property-information 2>/dev/null || true

# ========== 层级 2: 配置文件层（改变频率中等）==========
# 复制配置文件（不经常改变）
COPY tsconfig.json vite.config.ts tailwind.config.js postcss.config.js index.html ./
COPY nginx.conf ./

# ========== 层级 3: 源码层（改变频率最高）==========
# 复制源代码（频繁改变）
# 这一步应该是最后一步，这样源码改变只会重新执行构建，不会重新安装依赖
COPY src ./src
COPY public ./public

# ========== 层级 4: 构建层（每次源码改变都会执行）==========
# 构建生产版本
RUN npm run build

# ========== 阶段2: 生产阶段 ==========
FROM nginx:alpine

# 复制构建产物到nginx目录
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制nginx配置文件
COPY --from=builder /app/nginx.conf /etc/nginx/conf.d/default.conf

# 暴露端口
EXPOSE 80

# 启动nginx
CMD ["nginx", "-g", "daemon off;"]
